name: Build and Publish Wheels

on:
    push:
        tags:
            - "v*"

jobs:
    build:
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                os: [ubuntu-latest, windows-latest, macos-latest]

        steps:
            - uses: actions/checkout@v4

            - name: Build wheels
              uses: pypa/cibuildwheel@v2.16
              env:
                  CIBW_BUILD: cp39-* cp310-* cp311-* cp312-* cp313-*
                  CIBW_SKIP: "*-musllinux*"

                  # Ensure release build
                  CIBW_ENVIRONMENT: >
                      CMAKE_ARGS="-DCMAKE_BUILD_TYPE=Release"

                  # ---- macOS OpenMP Fix ----
                  # Install libomp before build
                  CIBW_BEFORE_BUILD_MACOS: brew install libomp

                  # Tell clang where libomp lives (Apple Silicon path)
                  CIBW_ENVIRONMENT_MACOS: >
                      CPPFLAGS="-I/opt/homebrew/opt/libomp/include"
                      LDFLAGS="-L/opt/homebrew/opt/libomp/lib"
                      CMAKE_ARGS="-DCMAKE_BUILD_TYPE=Release"

            - name: Store wheels
              uses: actions/upload-artifact@v4
              with:
                  path: wheelhouse/*.whl

    publish:
        needs: build
        runs-on: ubuntu-latest
        permissions:
            id-token: write

        steps:
            - uses: actions/download-artifact@v4
              with:
                  path: dist

            - name: Publish to PyPI
              uses: pypa/gh-action-pypi-publish@release/v1
